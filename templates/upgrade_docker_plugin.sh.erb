#!/bin/bash -x

LISTEN_PORT=<%= @listen_port_http %>

(grep "docker-plugin:1.1.9" /var/jenkins_home/plugins.txt > /dev/null) && {
	sleep 30

	sed -i 's/docker-plugin:1.1.9/docker-plugin:1.2.0/g' /var/jenkins_home/plugins.txt

	export PLUGINS_FORCE_UPGRADE=true
	export OVERRIDE_MANUAL=true
	export TRY_UPGRADE_IF_NO_MARKER=true
	
	/usr/local/bin/install-plugins.sh docker-plugin:1.2.0
	
	wget -O /tmp/jenkins-cli.jar http://localhost:${LISTEN_PORT}/jnlpJars/jenkins-cli.jar
	java -jar /tmp/jenkins-cli.jar -s http://localhost:${LISTEN_PORT}/ safe-restart
}
